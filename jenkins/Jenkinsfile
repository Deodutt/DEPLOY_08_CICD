pipeline {
    agent {
        label "jenkins-agent"
    }

    environment {
        DOCKERHUB_CREDENTIALS = credentials("rixardo-dockerhub")
    }

    stages {
        // Creating the front end application using NPM
        stage('Build') { 
            steps { 
                sh '''
                cd application/frontend/
                npm install
                npm run build
                sudo npm install -g serve
                serve -s build &
                '''
                sh 'echo "completed build"'
            }
        }
        // Testing the front end application
        stage('Test') { 
            steps { 
                sh '''
                npx cypress run --spec ./cypress/integration/test.spec.js
                '''
                sh 'echo "completed build"'
            }
            post {
                always {
                junit 'results/cypress-report.xml'
                }
            }
        }

        stage('Packaging') { 
            steps {
                sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
                sh 'echo "completed login"'

                sh 'docker build -f ./application/frontend/Dockerfile . -t rixardo/deploy08-frontend:latest'
                sh 'echo "completed building front-end application"'

                sh 'docker push rixardo/deploy08-frontend:latest'
                sh 'echo "completed pushing front-end application"'

                sh 'docker build -f ./application/backend/Dockerfile . -t rixardo/deploy08-backend:latest'
                sh 'echo "completed building back-end application"'

                sh 'docker push rixardo/deploy08-backend:latest'
                sh 'echo "completed pushing back-end application"'
            }
            post {
                always {
                sh 'docker rmi rixardo/deploy08-frontend:latest'
                sh 'docker rmi rixardo/deploy08-backend:latest'
                }
        }
        

        stage('Deploying') { 
            agent {
                label "jenkins-production"
            }
            steps {
                sh 'docker stack deploy -c ./application/frontend/docker-compose-stack.yml frontend-app'
                sh 'echo "deployed frontend stack"'

                sh 'docker stack deploy -c ./application/backend/docker-compose-stack.yml backend-app'
                sh 'echo "deployed backend stack"'
            }
            post {
                always {
                sh 'docker rmi rixardo/deploy08-frontend:latest'
                sh 'docker rmi rixardo/deploy08-backend:latest'
                }
            }
        }
    }
}
